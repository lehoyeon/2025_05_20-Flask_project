<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¬¼ê±´ ëŒ€ì—¬/ë°˜ë‚© ì‹œìŠ¤í…œ</title>
  <style>
    body {
      font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
      padding: 30px;
      background-color: #f7f7f7;
    }
    h1 { color: #333; }
    .section {
      margin-bottom: 40px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label, select, input {
      display: block;
      margin: 10px 0;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button.return-btn {
      background-color: #f44336;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    .returned {
      color: gray;
    }
    .rented {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>ğŸ“¦ ë¬¼ê±´ ëŒ€ì—¬/ë°˜ë‚© ì‹œìŠ¤í…œ</h1>

  <!-- 1. ëŒ€ì—¬ -->
  <div class="section">
    <h2>1. ë¬¼ê±´ ëŒ€ì—¬</h2>
    <form id="rentalForm">
      <label for="userSelect">ì‚¬ìš©ì ì„ íƒ:</label>
      <select id="userSelect" name="user_id" required>
        <option value="" disabled selected>-- ì‚¬ìš©ì ì„ íƒ --</option>
        <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— JSë¡œ ì±„ì›Œì§ -->
      </select>

      <label for="itemSelect">ë¬¼ê±´ ì„ íƒ:</label>
      <select id="itemSelect" name="item_id" required>
        <option value="" disabled selected>-- ë¬¼ê±´ ì„ íƒ --</option>
        <!-- ë¬¼í’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— JSë¡œ ì±„ì›Œì§ -->
      </select>

      <label for="price">ëŒ€ì—¬ ê¸ˆì•¡:</label>
      <input type="text" id="price" name="price" readonly>

      <label for="rentalDate">ëŒ€ì—¬ì¼:</label>
      <input type="date" id="rentalDate" name="rent_date" readonly>

      <button type="submit">ëŒ€ì—¬í•˜ê¸°</button>
    </form>
  </div>

  <!-- 2. ëŒ€ì—¬í˜„í™© -->
  <div class="section">
    <h2>2. ëŒ€ì—¬ í˜„í™©</h2>
    <table id="rentalStatusTable">
      <thead>
        <tr>
          <th>ì‚¬ìš©ì</th>
          <th>ë¬¼ê±´ëª…</th>
          <th>ëŒ€ì—¬ì¼</th>
          <th>ê¸ˆì•¡(ì›)</th>
          <th>ìƒíƒœ</th>
          <th>ì•¡ì…˜</th>
        </tr>
      </thead>
      <tbody>
        <!-- ëŒ€ì—¬ í˜„í™© ë°ì´í„°ê°€ ì—¬ê¸° ë“¤ì–´ê° -->
      </tbody>
    </table>
  </div>

  <script>
  window.onload = async function () {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("rentalDate").value = today;

    const userSelect = document.getElementById("userSelect");
    const itemSelect = document.getElementById("itemSelect");

    try {
      // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
      const userRes = await fetch('/users'); 
      if (!userRes.ok) throw new Error("ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      const users = await userRes.json();
      users.forEach(user => {
        const option = document.createElement("option");
        option.value = user.user_id;
        option.textContent = user.name;
        userSelect.appendChild(option);
      });

      // ë¬¼í’ˆ ëª©ë¡ ë¡œë“œ
      const itemRes = await fetch('/items'); 
      if (!itemRes.ok) throw new Error("ë¬¼í’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      const items = await itemRes.json();
      items.forEach(item => {
        const option = document.createElement("option");
        option.value = item.item_id;
        const priceNum = Number(item.price);
        option.textContent = `${item.name} (${priceNum.toLocaleString()}ì›)`;
        option.setAttribute("data-price", priceNum);
        itemSelect.appendChild(option);
      });

      // ëŒ€ì—¬ í˜„í™©ë„ ê°™ì´ ë¶ˆëŸ¬ì˜¤ê¸°
      await loadRentalStatus();

    } catch (error) {
      alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
      console.error(error);
    }
  };

  // ê°€ê²© ìë™ ì„¤ì •
  document.getElementById("itemSelect").addEventListener("change", function () {
    const selected = this.options[this.selectedIndex];
    const price = selected.getAttribute("data-price");
    document.getElementById("price").value = price ? `${price} ì›` : "";
  });

  function formatDate(dateStr) {
  const d = new Date(dateStr);
  const year = d.getFullYear();
  const month = d.getMonth() + 1;
  const day = d.getDate();

  return `${year}ë…„ ${month}ì›” ${day}ì¼`;
}


  // ëŒ€ì—¬í•˜ê¸° ì œì¶œ
  document.getElementById("rentalForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = {
      user_id: document.getElementById("userSelect").value,
      item_id: document.getElementById("itemSelect").value,  // ê¸°ì¡´ ì˜¤íƒ€ ìˆ˜ì •
      rent_date: document.getElementById("rentalDate").value,
      price: parseInt(document.getElementById("price").value.replace(" ì›", "")),
      status: "ëŒ€ì—¬ì¤‘"
    };

    try {
      const res = await fetch('/api/rentals', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        alert("ëŒ€ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        // location.reload() ëŒ€ì‹  í˜„í™©ë§Œ ê°±ì‹ 
        await loadRentalStatus();
        this.reset();
        document.getElementById("rentalDate").value = new Date().toISOString().split('T')[0];
        document.getElementById("price").value = "";
      } else {
        alert("ëŒ€ì—¬ ì²˜ë¦¬ ì‹¤íŒ¨");
      }
    } catch (err) {
      alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
      console.error(err);
    }
  });

  // ëŒ€ì—¬ í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
  async function loadRentalStatus() {
    try {
      const res = await fetch('/api/rentals');
      if (!res.ok) throw new Error('ëŒ€ì—¬í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      const rentals = await res.json();

      const tbody = document.querySelector("#rentalStatusTable tbody");
      tbody.innerHTML = "";  // ì´ˆê¸°í™”

  rentals.forEach(rental => {
    const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>${rental.user_name || rental.user_id}</td>
    <td>${rental.item_name || rental.item_id}</td>
    <td>${formatDate(rental.rent_date)}</td>
    <td>${Number(rental.price).toLocaleString()}</td>
    <td class="${rental.status === 'ëŒ€ì—¬ì¤‘' ? 'rented' : 'returned'}">${rental.status}</td>
    <td>
      ${rental.status === 'ëŒ€ì—¬ì¤‘' ? `<button class="return-btn" data-id="${rental.rental_id}">ë°˜ë‚©</button>` : ''}
    </td>
  `;

  tbody.appendChild(tr);
});

      // ë°˜ë‚© ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
      document.querySelectorAll('.return-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const rentalId = e.target.getAttribute('data-id');
          if (!confirm('ì´ ë¬¼ê±´ì„ ë°˜ë‚© ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

          try {
            // ë°˜ë‚© API í˜¸ì¶œ (ë°±ì—”ë“œ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •)
            const res = await fetch(`/api/rentals/${rentalId}/return`, {
              method: 'PUT'
            });
            if (res.ok) {
              alert('ë°˜ë‚© ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
              await loadRentalStatus();
            } else {
              alert('ë°˜ë‚© ì²˜ë¦¬ ì‹¤íŒ¨');
            }
          } catch (err) {
            alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
            console.error(err);
          }
        });
      });

    } catch (err) {
      alert(err.message);
      console.error(err);
    }
  }
  </script>

</body>
</html>
